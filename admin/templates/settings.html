{% extends "layout.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - Hydra ä¹å¤´è›‡æ§åˆ¶å°{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-cyber-green cyber-glow mb-8">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
    
    <form
        id="config-form"
        hx-post="/settings/update"
        hx-target="#save-result"
        hx-swap="innerHTML"
        class="space-y-6"
    >
        <!-- é¡¹ç›®åŸºæœ¬ä¿¡æ¯ -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ“‹ é¡¹ç›®åŸºæœ¬ä¿¡æ¯</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é¡¹ç›®åç§°</label>
                    <input
                        type="text"
                        name="project_name"
                        value="{{ config.get('project_name', 'Hydra SEO Project') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="Hydra SEO Project"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">åŸºç¡€åŸŸå</label>
                    <input
                        type="text"
                        name="base_domain"
                        value="{{ config.get('base_domain', 'example.com') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="example.com"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">è¿è¡Œæ¨¡å¼</label>
                    <select name="mode" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        <option value="composite" {% if config.get('mode') == 'composite' %}selected{% endif %}>å¤åˆæ¨¡å¼ (Composite) - å¤šå­åŸŸåé…ç½®</option>
                        <option value="swarm" {% if config.get('mode') == 'swarm' %}selected{% endif %}>é›†ç¾¤æ¨¡å¼ (Swarm) - å…³é”®è¯è‡ªåŠ¨ç”Ÿæˆ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- LLM é…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ¤– LLM æä¾›è€…é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æä¾›è€…ç±»å‹</label>
                    <select name="llm[provider]" id="llm-provider" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        <option value="ollama" {% if config.get('llm', {}).get('provider') == 'ollama' %}selected{% endif %}>Ollama (æœ¬åœ°)</option>
                        <option value="openai" {% if config.get('llm', {}).get('provider') == 'openai' %}selected{% endif %}>OpenAI (äº‘ç«¯)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æ¨¡å‹åç§°</label>
                    <input
                        type="text"
                        name="llm[model]"
                        value="{{ config.get('llm', {}).get('model', 'llama3') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="llama3"
                    >
                </div>
                
                <div id="ollama-config">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Base URL (ä»… Ollama)</label>
                    <input
                        type="text"
                        name="llm[base_url]"
                        value="{{ config.get('llm', {}).get('base_url', 'http://localhost:11434') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="http://localhost:11434"
                    >
                </div>
                
                <div id="openai-config" style="display: none;">
                    <label class="block text-sm font-medium text-gray-300 mb-2">API Key (ä»… OpenAI)</label>
                    <input
                        type="password"
                        name="llm[api_key]"
                        value="{{ config.get('llm', {}).get('api_key', '') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="sk-..."
                    >
                    <p class="text-xs text-gray-500 mt-1">æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ OPENAI_API_KEY</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Temperature (0.0-2.0)</label>
                    <input
                        type="number"
                        step="0.1"
                        min="0"
                        max="2"
                        name="llm[temperature]"
                        value="{{ config.get('llm', {}).get('temperature', 0.7) }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æœ€å¤§ Token æ•°</label>
                    <input
                        type="number"
                        name="llm[max_tokens]"
                        value="{{ config.get('llm', {}).get('max_tokens', 2048) }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                    >
                </div>
            </div>
        </div>
        
        <!-- è¾“å‡ºé…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ“ è¾“å‡ºé…ç½®</h2>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">è¾“å‡ºç›®å½•</label>
                <input
                    type="text"
                    name="output[path]"
                    value="{{ config.get('output', {}).get('path', 'dist') }}"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                    placeholder="dist"
                >
            </div>
        </div>
        
        <!-- é»˜è®¤å†…å®¹ç­–ç•¥ -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ­ é»˜è®¤å†…å®¹ç­–ç•¥</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é»˜è®¤ä¼ªè£…ä¸Šä¸‹æ–‡</label>
                    <input
                        type="text"
                        name="default_mask_context"
                        value="{{ config.get('default_mask_context', 'Industrial Machinery') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="Industrial Machinery"
                    >
                    <p class="text-xs text-gray-500 mt-1">ç”¨äºè¯­ä¹‰ä¼ªè£…çš„ä¸»é¢˜é¢†åŸŸ</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é»˜è®¤äººç‰©è§’è‰²</label>
                    <input
                        type="text"
                        name="default_persona"
                        value="{{ config.get('default_persona', 'Senior Engineer') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="Senior Engineer"
                    >
                </div>
            </div>
        </div>
        
        <!-- åŸŸåæ‹“æ‰‘é…ç½® (Composite Mode) -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6" id="topology-section">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸŒ åŸŸåæ‹“æ‰‘é…ç½® (Composite Mode)</h2>
            <p class="text-sm text-gray-400 mb-4">é…ç½®å¤šä¸ªå­åŸŸååŠå…¶ç­–ç•¥</p>
            
            <div id="topology-list" class="space-y-4">
                {% for topo in config.get('topology', []) %}
                <div class="topology-item border border-gray-700 rounded p-4 bg-gray-900/50">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»æœºå</label>
                            <input type="text" name="topology[{{ loop.index0 }}][hostname]" value="{{ topo.get('hostname', '') }}" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">è§’è‰²</label>
                            <input type="text" name="topology[{{ loop.index0 }}][role]" value="{{ topo.get('role', '') }}" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ä¼ªè£…ä¸Šä¸‹æ–‡</label>
                            <input type="text" name="topology[{{ loop.index0 }}][mask_context]" value="{{ topo.get('mask_context', '') }}" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">äººç‰©è§’è‰²</label>
                            <input type="text" name="topology[{{ loop.index0 }}][persona]" value="{{ topo.get('persona', '') }}" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        </div>
                    </div>
                    <button type="button" onclick="this.closest('.topology-item').remove()" class="mt-2 text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addTopologyItem()" class="mt-4 px-4 py-2 bg-cyber-green/20 text-cyber-green rounded hover:bg-cyber-green/30 transition">+ æ·»åŠ åŸŸå</button>
        </div>
        
        <!-- Swarm Mode é…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6" id="swarm-section">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ Swarm Mode é…ç½®</h2>
            <p class="text-sm text-gray-400 mb-4">å…³é”®è¯åˆ—è¡¨ï¼Œæ¯ä¸ªå…³é”®è¯ä¼šæ˜ å°„åˆ° keyword.base_domain</p>
            
            <div id="keywords-list" class="space-y-2">
                {% for keyword in config.get('swarm', {}).get('keywords', []) %}
                <div class="keyword-item flex gap-2">
                    <input type="text" name="swarm[keywords][]" value="{{ keyword }}" class="flex-1 bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                    <button type="button" onclick="this.closest('.keyword-item').remove()" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700">åˆ é™¤</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addKeyword()" class="mt-4 px-4 py-2 bg-cyber-green/20 text-cyber-green rounded hover:bg-cyber-green/30 transition">+ æ·»åŠ å…³é”®è¯</button>
        </div>
        
        <!-- SEO é…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ” SEO é…ç½®</h2>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-300">ç”Ÿæˆç«™ç‚¹åœ°å›¾</label>
                    <label class="toggle-switch">
                        <input
                            type="checkbox"
                            name="seo[generate_sitemap]"
                            {% if config.get('seo', {}).get('generate_sitemap') %}checked{% endif %}
                            hx-post="/toggle/seo.generate_sitemap"
                            hx-trigger="change"
                            hx-vals='{"value": this.checked}'
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é»˜è®¤ç€é™†é¡µ</label>
                    <input
                        type="text"
                        name="seo[landing_page]"
                        value="{{ config.get('seo', {}).get('landing_page', '/') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æ¯é¡µæœ€å¤§å†…éƒ¨é“¾æ¥æ•°</label>
                    <input
                        type="number"
                        name="seo[max_internal_links]"
                        value="{{ config.get('seo', {}).get('max_internal_links', 5) }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                    >
                </div>
            </div>
        </div>
        
        <!-- Cloudflare é…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">â˜ï¸ Cloudflare é…ç½®</h2>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-300">å¯ç”¨ Cloudflare è‡ªåŠ¨åŒ–</label>
                    <label class="toggle-switch">
                        <input
                            type="checkbox"
                            name="cloudflare[enabled]"
                            {% if config.get('cloudflare', {}).get('enabled') %}checked{% endif %}
                            hx-post="/toggle/cloudflare.enabled"
                            hx-trigger="change"
                            hx-vals='{"value": this.checked}'
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-300">DNS è®°å½•é€šè¿‡ä»£ç†</label>
                    <label class="toggle-switch">
                        <input
                            type="checkbox"
                            name="cloudflare[proxied]"
                            {% if config.get('cloudflare', {}).get('proxied') %}checked{% endif %}
                            hx-post="/toggle/cloudflare.proxied"
                            hx-trigger="change"
                            hx-vals='{"value": this.checked}'
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">API Token</label>
                    <input
                        type="password"
                        name="cloudflare[api_token]"
                        value="{{ config.get('cloudflare', {}).get('api_token', '') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="YOUR_CF_TOKEN"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Zone ID</label>
                    <input
                        type="text"
                        name="cloudflare[zone_id]"
                        value="{{ config.get('cloudflare', {}).get('zone_id', '') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="YOUR_ZONE_ID"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">è´¦æˆ·é‚®ç®±</label>
                    <input
                        type="email"
                        name="cloudflare[email]"
                        value="{{ config.get('cloudflare', {}).get('email', '') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="your@email.com"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æœåŠ¡å™¨å…¬ç½‘ IP</label>
                    <input
                        type="text"
                        name="cloudflare[server_ip]"
                        value="{{ config.get('cloudflare', {}).get('server_ip', '') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="YOUR_VPS_IP"
                    >
                </div>
            </div>
        </div>
        
        <!-- æ—¥å¿—é…ç½® -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <h2 class="text-xl font-semibold text-cyber-green mb-4">ğŸ“œ æ—¥å¿—é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æ—¥å¿—çº§åˆ«</label>
                    <select name="logging[level]" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                        <option value="DEBUG" {% if config.get('logging', {}).get('level') == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        <option value="INFO" {% if config.get('logging', {}).get('level') == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="WARNING" {% if config.get('logging', {}).get('level') == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="ERROR" {% if config.get('logging', {}).get('level') == 'ERROR' %}selected{% endif %}>ERROR</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æ—¥å¿—æ–‡ä»¶è·¯å¾„</label>
                    <input
                        type="text"
                        name="logging[file]"
                        value="{{ config.get('logging', {}).get('file', 'hydra.log') }}"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200"
                        placeholder="hydra.log"
                    >
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-300">è¾“å‡ºåˆ°æ§åˆ¶å°</label>
                    <label class="toggle-switch">
                        <input
                            type="checkbox"
                            name="logging[console]"
                            {% if config.get('logging', {}).get('console', true) %}checked{% endif %}
                            hx-post="/toggle/logging.console"
                            hx-trigger="change"
                            hx-vals='{"value": this.checked}'
                        >
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end">
            <button
                type="submit"
                class="px-6 py-3 bg-cyber-green text-black font-semibold rounded hover:bg-cyber-green/80 transition"
            >
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </div>
        
        <div id="save-result" class="mt-4"></div>
    </form>
</div>

<script>
    // æ ¹æ® LLM æä¾›è€…æ˜¾ç¤º/éšè—é…ç½®
    document.getElementById('llm-provider').addEventListener('change', function() {
        const provider = this.value;
        document.getElementById('ollama-config').style.display = provider === 'ollama' ? 'block' : 'none';
        document.getElementById('openai-config').style.display = provider === 'openai' ? 'block' : 'none';
    });
    
    // åˆå§‹åŒ–æ˜¾ç¤º
    const currentProvider = document.getElementById('llm-provider').value;
    document.getElementById('ollama-config').style.display = currentProvider === 'ollama' ? 'block' : 'none';
    document.getElementById('openai-config').style.display = currentProvider === 'openai' ? 'block' : 'none';
    
    // æ ¹æ®æ¨¡å¼æ˜¾ç¤º/éšè—é…ç½®
    const mode = document.querySelector('select[name="mode"]').value;
    document.getElementById('topology-section').style.display = mode === 'composite' ? 'block' : 'none';
    document.getElementById('swarm-section').style.display = mode === 'swarm' ? 'block' : 'none';
    
    document.querySelector('select[name="mode"]').addEventListener('change', function() {
        const mode = this.value;
        document.getElementById('topology-section').style.display = mode === 'composite' ? 'block' : 'none';
        document.getElementById('swarm-section').style.display = mode === 'swarm' ? 'block' : 'none';
    });
    
    // æ·»åŠ æ‹“æ‰‘é¡¹
    function addTopologyItem() {
        const list = document.getElementById('topology-list');
        const index = list.children.length;
        const item = document.createElement('div');
        item.className = 'topology-item border border-gray-700 rounded p-4 bg-gray-900/50';
        item.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»æœºå</label>
                    <input type="text" name="topology[${index}][hostname]" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">è§’è‰²</label>
                    <input type="text" name="topology[${index}][role]" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¼ªè£…ä¸Šä¸‹æ–‡</label>
                    <input type="text" name="topology[${index}][mask_context]" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">äººç‰©è§’è‰²</label>
                    <input type="text" name="topology[${index}][persona]" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200">
                </div>
            </div>
            <button type="button" onclick="this.closest('.topology-item').remove()" class="mt-2 text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button>
        `;
        list.appendChild(item);
    }
    
    // æ·»åŠ å…³é”®è¯
    function addKeyword() {
        const list = document.getElementById('keywords-list');
        const item = document.createElement('div');
        item.className = 'keyword-item flex gap-2';
        item.innerHTML = `
            <input type="text" name="swarm[keywords][]" class="flex-1 bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-200" placeholder="å…³é”®è¯">
            <button type="button" onclick="this.closest('.keyword-item').remove()" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700">åˆ é™¤</button>
        `;
        list.appendChild(item);
    }
</script>
{% endblock %}
