{% extends "layout.html" %}

{% block title %}ç«™ç‚¹ç®¡ç† - Hydra ä¹å¤´è›‡æ§åˆ¶å°{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-cyber-green cyber-glow">ğŸŒ ç«™ç‚¹ç®¡ç†</h1>
        <button
            onclick="showAddSiteModal()"
            class="px-6 py-3 bg-cyber-green text-black font-semibold rounded hover:bg-cyber-green/80 transition flex items-center space-x-2"
        >
            <span>+</span>
            <span>æ·»åŠ æ–°ç«™ç‚¹</span>
        </button>
    </div>
    
    <!-- Search Bar -->
    <div class="mb-6">
        <div class="relative max-w-md">
            <input
                type="text"
                id="site-search"
                placeholder="æœç´¢ç«™ç‚¹..."
                class="w-full bg-dark-panel border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:border-cyber-green outline-none"
                onkeyup="filterSites()"
            >
            <span class="absolute left-3 top-2.5 text-gray-500">ğŸ”</span>
        </div>
    </div>
    
    <!-- Sites Table -->
    <div class="bg-dark-panel cyber-border rounded-lg overflow-hidden">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-800/50 text-gray-200">
                <tr>
                    <th class="px-6 py-4">åŸŸå</th>
                    <th class="px-6 py-4">é¢†åŸŸ/ä¸Šä¸‹æ–‡</th>
                    <th class="px-6 py-4">è§’è‰²</th>
                    <th class="px-6 py-4">äººç‰©è§’è‰²</th>
                    <th class="px-6 py-4">çŠ¶æ€</th>
                    <th class="px-6 py-4 text-right">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="sites-table-body" class="divide-y divide-slate-800">
                {% for site in sites %}
                <tr class="site-row hover:bg-slate-800/30">
                    <td class="px-6 py-4 text-white font-medium">{{ site.hostname }}</td>
                    <td class="px-6 py-4 text-gray-400">{{ site.niche }}</td>
                    <td class="px-6 py-4 text-gray-400">{{ site.role }}</td>
                    <td class="px-6 py-4 text-gray-400">{{ site.persona }}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs border {% if site.status == 'Active' %}bg-green-500/10 text-green-400 border-green-500/20{% else %}bg-yellow-500/10 text-yellow-400 border-yellow-500/20{% endif %}">
                            {{ site.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editSite({{ site.id }})" class="text-cyber-green hover:text-cyber-green/80 text-sm mr-3">ç¼–è¾‘</button>
                        <button onclick="deleteSite({{ site.id }})" class="text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if not sites %}
        <div class="p-12 text-center text-gray-500">
            <p class="mb-4">æš‚æ— ç«™ç‚¹</p>
            <button onclick="showAddSiteModal()" class="px-4 py-2 bg-cyber-green/20 text-cyber-green rounded hover:bg-cyber-green/30 transition">
                æ·»åŠ ç¬¬ä¸€ä¸ªç«™ç‚¹
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Site Modal -->
<div id="add-site-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-dark-panel cyber-border rounded-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-xl font-semibold text-cyber-green mb-4">æ·»åŠ æ–°ç«™ç‚¹</h2>
        
        <form id="add-site-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»æœºå</label>
                <input
                    type="text"
                    name="hostname"
                    required
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-cyber-green outline-none"
                    placeholder="example.com"
                >
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">é¢†åŸŸ/ä¼ªè£…ä¸Šä¸‹æ–‡</label>
                <input
                    type="text"
                    name="mask_context"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-cyber-green outline-none"
                    placeholder="Industrial Machinery"
                >
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">è§’è‰²</label>
                <input
                    type="text"
                    name="role"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-cyber-green outline-none"
                    placeholder="LandingPage"
                >
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">äººç‰©è§’è‰²</label>
                <input
                    type="text"
                    name="persona"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:border-cyber-green outline-none"
                    placeholder="Senior Engineer"
                >
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button
                    type="button"
                    onclick="hideAddSiteModal()"
                    class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600 transition"
                >
                    å–æ¶ˆ
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 bg-cyber-green text-black font-semibold rounded hover:bg-cyber-green/80 transition"
                >
                    æ·»åŠ 
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showAddSiteModal() {
        isEditMode = false;
        editSiteId = null;
        document.getElementById('add-site-form').reset();
        document.querySelector('#add-site-form button[type="submit"]').textContent = 'æ·»åŠ ';
        document.getElementById('add-site-modal').classList.remove('hidden');
    }
    
    function filterSites() {
        const search = document.getElementById('site-search').value.toLowerCase();
        const rows = document.querySelectorAll('.site-row');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    let isEditMode = false;
    let editSiteId = null;
    
    document.getElementById('add-site-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            let response;
            if (isEditMode && editSiteId !== null) {
                // æ›´æ–°æ¨¡å¼
                response = await fetch(`/api/sites/${editSiteId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                // æ·»åŠ æ¨¡å¼
                response = await fetch('/api/sites', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }
            
            const result = await response.json();
            if (result.success) {
                showToast(isEditMode ? 'ç«™ç‚¹å·²æ›´æ–°' : 'ç«™ç‚¹å·²æ·»åŠ ');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('é”™è¯¯: ' + result.error);
            }
        } catch (error) {
            showToast((isEditMode ? 'æ›´æ–°' : 'æ·»åŠ ') + 'å¤±è´¥: ' + error);
        }
    });
    
    // é‡ç½®ç¼–è¾‘æ¨¡å¼
    function hideAddSiteModal() {
        document.getElementById('add-site-modal').classList.add('hidden');
        document.getElementById('add-site-form').reset();
        isEditMode = false;
        editSiteId = null;
        document.querySelector('#add-site-form button[type="submit"]').textContent = 'æ·»åŠ ';
    }
    
    async function editSite(id) {
        try {
            // è·å–ç«™ç‚¹ä¿¡æ¯
            const response = await fetch(`/api/sites/${id}`);
            const result = await response.json();
            
            if (result.success) {
                const site = result.site;
                // å¡«å……è¡¨å•
                document.querySelector('input[name="hostname"]').value = site.hostname || '';
                document.querySelector('input[name="mask_context"]').value = site.mask_context || '';
                document.querySelector('input[name="role"]').value = site.role || '';
                document.querySelector('input[name="persona"]').value = site.persona || '';
                
                // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                isEditMode = true;
                editSiteId = id;
                document.querySelector('#add-site-form button[type="submit"]').textContent = 'æ›´æ–°';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('add-site-modal').classList.remove('hidden');
            } else {
                showToast('è·å–ç«™ç‚¹ä¿¡æ¯å¤±è´¥');
            }
        } catch (error) {
            showToast('ç¼–è¾‘å¤±è´¥: ' + error);
        }
    }
    
    async function deleteSite(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç«™ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/sites/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            if (result.success) {
                showToast('ç«™ç‚¹å·²åˆ é™¤');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('é”™è¯¯: ' + result.error);
            }
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error);
        }
    }
    
    // è‡ªåŠ¨åˆ·æ–°ç«™ç‚¹åˆ—è¡¨
    setInterval(async () => {
        try {
            const response = await fetch('/api/sites');
            const data = await response.json();
            // æ›´æ–°è¡¨æ ¼ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥æ›´æ™ºèƒ½ï¼‰
        } catch (e) {}
    }, 10000);
</script>
{% endblock %}

