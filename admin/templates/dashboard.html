{% extends "layout.html" %}

{% block title %}ä»ªè¡¨ç›˜ - Hydra ä¹å¤´è›‡æ§åˆ¶å°{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-cyber-green cyber-glow mb-8">ğŸ“Š ä»ªè¡¨ç›˜</h1>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="stats-cards">
        <!-- æ€»æ–‡ç« æ•° -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-slate-800 text-blue-400">
                    <span class="text-2xl">ğŸ“„</span>
                </div>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1" id="stat-articles">-</h3>
            <p class="text-sm text-gray-400">æ€»æ–‡ç« æ•°</p>
        </div>
        
        <!-- æ€»ç«™ç‚¹æ•° -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-slate-800 text-green-400">
                    <span class="text-2xl">ğŸŒ</span>
                </div>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1" id="stat-sites">-</h3>
            <p class="text-sm text-gray-400">æ€»ç«™ç‚¹æ•°</p>
        </div>
        
        <!-- æ´»è·ƒç«™ç‚¹ -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-slate-800 text-orange-400">
                    <span class="text-2xl">âš¡</span>
                </div>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1" id="stat-active">-</h3>
            <p class="text-sm text-gray-400">æ´»è·ƒç«™ç‚¹</p>
        </div>
        
        <!-- ä»Šæ—¥ç”Ÿæˆ -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-slate-800 text-purple-400">
                    <span class="text-2xl">ğŸš€</span>
                </div>
            </div>
            <h3 class="text-3xl font-bold text-white mb-1" id="stat-today">-</h3>
            <p class="text-sm text-gray-400">ä»Šæ—¥ç”Ÿæˆ</p>
        </div>
    </div>
    
    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Engine Status -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-300">å¼•æ“çŠ¶æ€</h3>
                <span class="w-3 h-3 rounded-full {% if status.engine_ready %}bg-cyber-green{% else %}bg-red-500{% endif %}"></span>
            </div>
            <p class="text-sm text-gray-400">
                {% if status.engine_ready %}
                    âœ“ å°±ç»ª
                {% else %}
                    âœ— æœªå°±ç»ª
                {% endif %}
            </p>
        </div>
        
        <!-- LLM Health -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-300">LLM æä¾›è€…</h3>
                <span class="w-3 h-3 rounded-full {% if status.llm_health %}bg-cyber-green{% else %}bg-yellow-500{% endif %}"></span>
            </div>
            <p class="text-sm text-gray-400">
                {% if status.llm_health %}
                    âœ“ å¥åº·
                {% else %}
                    âš  æ£€æŸ¥è¿æ¥
                {% endif %}
            </p>
        </div>
        
        <!-- Generation Status -->
        <div class="bg-dark-panel cyber-border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-300">ç”ŸæˆçŠ¶æ€</h3>
                <span class="w-3 h-3 rounded-full {% if status.generation_running %}bg-yellow-500 animate-pulse{% elif status.generation_error %}bg-red-500{% else %}bg-gray-500{% endif %}"></span>
            </div>
            <p class="text-sm text-gray-400">
                {% if status.generation_running %}
                    â³ è¿è¡Œä¸­...
                {% elif status.generation_error %}
                    âœ— é”™è¯¯
                {% else %}
                    âœ“ ç©ºé—²
                {% endif %}
            </p>
        </div>
    </div>
    
    <!-- Action Center -->
    <div class="bg-dark-panel cyber-border rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-cyber-green mb-4">æ“ä½œä¸­å¿ƒ</h2>
        
        <div class="flex items-center gap-4">
            <button
                id="generate-btn"
                hx-post="/action/generate"
                hx-target="#generate-result"
                hx-swap="innerHTML"
                class="px-6 py-3 bg-cyber-green text-black font-semibold rounded hover:bg-cyber-green/80 transition disabled:opacity-50 disabled:cursor-not-allowed"
                {% if status.generation_running %}disabled{% endif %}
            >
                {% if status.generation_running %}
                    <span class="inline-block animate-spin mr-2">â³</span>
                    ç”Ÿæˆä¸­...
                {% else %}
                    ğŸš€ ç”Ÿæˆç«™ç‚¹
                {% endif %}
            </button>
            
            <button
                hx-get="/status"
                hx-target="#status-info"
                hx-swap="innerHTML"
                hx-trigger="every 2s"
                class="px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600 transition"
            >
                ğŸ”„ åˆ·æ–°çŠ¶æ€
            </button>
        </div>
        
        <div id="generate-result" class="mt-4"></div>
    </div>
    
    <!-- Last Run Info -->
    {% if status.last_run %}
    <div class="bg-dark-panel cyber-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-cyber-green mb-4">ä¸Šæ¬¡è¿è¡Œ</h2>
        <p class="text-gray-400">
            <span class="text-cyber-green">â°</span>
            {{ status.last_run }}
        </p>
        {% if status.generation_error %}
        <div class="mt-4 p-4 bg-red-900/30 border border-red-500 rounded">
            <p class="text-red-400 text-sm">{{ status.generation_error }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Status Info (Auto-refresh) -->
    <div id="status-info" class="hidden"></div>
</div>

<script>
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            
            document.getElementById('stat-articles').textContent = stats.total_articles || 0;
            document.getElementById('stat-sites').textContent = stats.total_sites || 0;
            document.getElementById('stat-active').textContent = stats.active_sites || 0;
            document.getElementById('stat-today').textContent = stats.today_generated || 0;
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // Auto-refresh status every 5 seconds
    setInterval(() => {
        fetch('/status')
            .then(r => r.json())
            .then(data => {
                // Update UI based on status
                const generateBtn = document.getElementById('generate-btn');
                if (data.generation_running) {
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<span class="inline-block animate-spin mr-2">â³</span> ç”Ÿæˆä¸­...';
                } else {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = 'ğŸš€ ç”Ÿæˆç«™ç‚¹';
                }
            });
        
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        loadStats();
    }, 5000);
    
    // åˆå§‹åŠ è½½
    loadStats();
</script>
{% endblock %}
